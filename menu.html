<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menú - Mi Restaurante</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#ff4f81;
      --secondary:#0b0b0b;
      --light:#ffffff;
      --muted:rgba(255,255,255,.65);
      --glass:rgba(255,255,255,.06);
      --glass-2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.12);
      --bg-gradient:linear-gradient(135deg,#ff4f81,#ff8fbf);
      --shine:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.25) 20%, transparent 40%);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:#0b0b0b;color:var(--light);padding:0}
    .container{max-width:1200px;margin:0 auto;padding:20px;animation:fadeIn .7s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* Header sticky premium */
    .header-wrap{position:sticky;top:0;z-index:70;backdrop-filter:saturate(120%) blur(8px);background:linear-gradient(180deg, rgba(17,17,17,.8), rgba(17,17,17,.4));border-bottom:1px solid var(--stroke)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:14px 20px;margin:0 auto;max-width:1200px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;background:var(--bg-gradient);display:grid;place-items:center;color:#111;font-weight:800;box-shadow:0 10px 24px rgba(255,79,129,.2);cursor:pointer}
    h1{font-size:22px}
    .lead{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:10px;align-items:center}
    .search{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);background:var(--glass);color:var(--light);min-width:220px;transition:border .2s, box-shadow .2s}
    .search:focus{outline:none;border-color:#ffa0c1;box-shadow:0 0 0 3px rgba(255,79,129,.2)}
    .pill{padding:10px 14px;border-radius:999px;border:1px solid var(--stroke);background:var(--glass);color:var(--light);cursor:pointer;transition:transform .15s ease, background .25s ease}
    .pill:hover{transform:translateY(-1px);background:var(--glass-2)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px auto 0;max-width:1200px;padding:0 20px 14px}
    .tab{position:relative;isolation:isolate;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--glass);cursor:pointer;font-size:13px;transition:background .25s, transform .15s}
    .tab:hover{transform:translateY(-1px);background:var(--glass-2)}
    .tab.active{background:var(--bg-gradient);color:#111;border-color:transparent;font-weight:700;box-shadow:0 8px 20px rgba(255,79,129,.25)}
    .tab.active::after{content:"";position:absolute;inset:-2px;border-radius:999px;border:1.5px solid rgba(255,79,129,.45);pointer-events:none}

    /* Grid */
    .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--stroke);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.5);transition:.25s transform,.25s box-shadow;opacity:0;animation:rise .5s ease forwards}
    @keyframes rise{to{opacity:1;transform:translateY(0)}}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,.6)}

    /* Imagen con zoom + brillo */
    .img-wrap{position:relative;overflow:hidden}
    .img-wrap::after{content:"";position:absolute;inset:0;background:var(--shine);transform:translateX(-120%);}
    .card:hover .img-wrap::after{animation:shine 1.2s ease}
    @keyframes shine{to{transform:translateX(120%)}}
    .card img{width:100%;height:180px;object-fit:cover;display:block;transition:transform .45s ease}
    .card:hover img{transform:scale(1.06)}

    .card-body{padding:14px}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .name{font-weight:700}
    .price{background:var(--bg-gradient);color:#111;padding:6px 10px;border-radius:10px;font-weight:800}
    .desc{margin-top:6px;color:var(--muted);font-size:13px;min-height:36px}
    .meta{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
    .badge{font-size:11px;padding:6px 8px;border-radius:999px;background:var(--glass);border:1px solid var(--stroke)}
    .badge.agotado{color:#ff6b6b;border-color:#ff6b6b;background:rgba(255,107,107,.1)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* Botones primary con microinteracción */
    .actions-row{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:var(--glass);color:var(--light);cursor:pointer;font-weight:600;transition:transform .12s ease, background .25s ease, box-shadow .25s ease}
    .btn:hover{transform:translateY(-1px);background:var(--glass-2)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:var(--bg-gradient);color:#111;border-color:transparent}
    .btn.primary:hover{box-shadow:0 10px 24px rgba(255,79,129,.25)}

    /* Selectores de variante y tamaño */
    .variant,.size{width:100%;appearance:none;-webkit-appearance:none;-moz-appearance:none;margin-top:8px;padding:12px 44px 12px 14px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));color:var(--light);font-weight:600;transition:border .2s, box-shadow .25s ease, transform .15s}
    .variant:hover,.size:hover{transform:translateY(-1px)}
    .variant:focus,.size:focus{outline:none;border-color:#ffa0c1;box-shadow:0 0 0 3px rgba(255,79,129,.2)}
    .select-wrap{position:relative;display:block;margin-top:8px}
    .select-wrap::after{content:"";position:absolute;right:12px;top:50%;width:16px;height:16px;transform:translateY(-50%) rotate(0deg);transition:transform .25s ease, filter .25s ease;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-size:16px 16px;background-repeat:no-repeat;filter:drop-shadow(0 1px 1px rgba(0,0,0,.3))}
    .select-wrap.open::after{transform:translateY(-50%) rotate(180deg)}

    /* Tema oscuro del desplegable nativo y hover de opciones */
    .variant{background-color:#1a1a1a;color:#fff}
    .variant option{background-color:#1a1a1a;color:#fff}
    .variant option:hover{background-color:#ff4f81;color:#111}
    .variant option:checked{background-color:#ff8fbf;color:#111}

    /* Segmented controls (chips) */
    .segmented{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .seg-btn{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--glass);color:var(--light);font-size:13px;cursor:pointer;transition:transform .12s ease, background .25s ease, box-shadow .25s ease}
    .seg-btn:hover{transform:translateY(-1px);background:var(--glass-2)}
    .seg-btn.active{background:var(--bg-gradient);color:#111;border-color:transparent;box-shadow:0 8px 18px rgba(255,79,129,.25)}
    .seg-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(255,79,129,.25)}
    .seg-label{margin-top:10px;font-size:12px;color:var(--muted)}

    footer{margin:24px 0;text-align:center;color:var(--muted);font-size:12px}

    /* Modal imagen */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1001;cursor:zoom-out}
    .modal.show{display:flex}
    .modal-content{max-width:900px;width:95%;position:relative}
    .modal img{width:100%;border-radius:14px;animation:zoom .25s ease}
    @keyframes zoom{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
    .modal-close{position:absolute;top:10px;right:10px;padding:8px 10px;border-radius:10px;border:0;background:var(--bg-gradient);font-weight:800;color:#111;cursor:pointer}

    /* Carrito (drawer) */
    .cart-fab{position:fixed;right:22px;bottom:22px;background:var(--bg-gradient);color:#111;border:0;border-radius:999px;padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:0 12px 28px rgba(255,79,129,.25);z-index:65;transition:transform .15s ease}
    .cart-fab:hover{transform:translateY(-1px)}
    .drawer{position:fixed;top:0;right:0;height:100%;width:360px;max-width:92vw;background:#111;border-left:1px solid var(--stroke);box-shadow:-20px 0 40px rgba(0,0,0,.6);transform:translateX(100%);transition:transform .3s ease;z-index:70;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer header{padding:16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .drawer h2{font-size:18px}
    .drawer .close{background:transparent;border:0;color:var(--light);font-size:20px;cursor:pointer}
    .cart-list{padding:10px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:10px}
    .item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid var(--stroke);border-radius:12px;background:var(--glass)}
    .thumb{width:56px;height:56px;object-fit:cover;border-radius:10px}
    .i-name{font-weight:600}
    .i-price{color:var(--muted);font-size:12px}
    .qty{display:flex;align-items:center;gap:6px}
    .step{width:26px;height:26px;border-radius:8px;border:1px solid var(--stroke);background:var(--glass);color:var(--light);cursor:pointer;font-weight:800}
    .remove{background:transparent;border:0;color:var(--muted);cursor:pointer}
    .drawer footer{padding:14px;border-top:1px solid var(--stroke)}
    .row{display:flex;justify-content:space-between;margin:4px 0}
    .total{font-weight:800;font-size:18px}
    .checkout{width:100%;margin-top:10px;padding:12px;border-radius:12px;border:0;background:var(--bg-gradient);color:#111;font-weight:800;cursor:pointer}
    .clear{width:100%;margin-top:8px;padding:10px;border-radius:12px;background:var(--glass);border:1px solid var(--stroke);color:var(--light);cursor:pointer}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:100px;transform:translateX(-50%) translateY(20px);background:#111;border:1px solid var(--stroke);padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:.25s;z-index:75}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

    /* Funciones integradas de tu código */
    .notificacion-agotado{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:15px 20px;background:#ff4d4d;color:#fff;font-weight:700;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.35);opacity:0;transition:opacity .35s ease;z-index:80;text-align:center}
    .notificacion-agotado.mostrar{opacity:1}
    .oculto{display:none}
    .logo.spin{animation:spinY .6s forwards}
    @keyframes spinY{from{transform:rotateY(0)}to{transform:rotateY(360deg)}}

    @media (max-width:520px){
      .search{min-width:0;width:100%}
      .actions{flex-direction:column;align-items:stretch}
      .price{white-space:nowrap}
    }
  </style>
</head>
<body>
  <div class="header-wrap">
    <header>
      <div class="brand">
        <div class="logo" id="brandLogo">Mi</div>
        <div>
          <h1>Mi Restaurante</h1>
          <div class="lead">Menú digital — clic en la imagen para ampliar</div>
        </div>
      </div>
      <div class="actions">
        <input id="search" class="search" placeholder="Buscar plato o ingrediente..." />
        <button class="pill" id="reset">Limpiar</button>
      </div>
    </header>
    <nav class="tabs" id="tabs">
      <button class="tab active" data-cat="all">Todo</button>
      <button class="tab" data-cat="trancas">Trancas</button>
      <button class="tab" data-cat="tortas">Tortas</button>
      <button class="tab" data-cat="panuchos">Panuchos</button>
      <button class="tab" data-cat="tacos">Tacos</button>
      <button class="tab" data-cat="tostadas">Tostadas</button>
    </nav>
  </div>

  <div class="container">
    <main class="menu-grid" id="menuGrid"></main>

    <footer>© <span id="year"></span> Mi Restaurante — Menú digital</footer>
  </div>

  <!-- Modal de imagen -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <button class="modal-close" id="closeModal">Cerrar</button>
      <img id="modalImg" src="" alt="Imagen ampliada" />
    </div>
  </div>

  <!-- Drawer del carrito -->
  <button class="cart-fab" id="cartFab">Carrito (0)</button>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <header>
      <h2>Tu pedido</h2>
      <button class="close" id="drawerClose" aria-label="Cerrar">✕</button>
    </header>
    <section class="cart-list" id="cartList"></section>
    <footer>
      <div class="row"><span>Subtotal</span><span id="sub"></span></div>
      <div class="row"><span>Impuestos (0%)</span><span id="tax"></span></div>
      <div class="row total"><span>Total</span><span id="total"></span></div>
      <button class="checkout" id="checkout">Confirmar pedido</button>
      <button class="clear" id="clear">Vaciar carrito</button>
    </footer>
  </aside>

  <!-- Notificación de producto agotado -->
  <div id="notificacion-agotado" class="notificacion-agotado oculto">Este producto está agotado.</div>

  <!-- Sonido al agregar -->
  <audio id="sonido-agregar" src="sonido.mp3" preload="auto"></audio>

  <!-- Toast -->
  <div class="toast" id="toast">Añadido al carrito</div>

  <script>
    // Utilidades
    const $ = (s,scope=document)=>scope.querySelector(s);
    const $$ = (s,scope=document)=>Array.from(scope.querySelectorAll(s));
    const fmt = (n)=>`$${Number(n).toFixed(2)}`;

    // Elementos
    const yearSpan = $('#year');
    const searchInput = $('#search');
    const resetBtn = $('#reset');
    const tabs = $('#tabs');
    const menuGrid = $('#menuGrid');
    const modal = $('#modal');
    const modalImg = $('#modalImg');
    const closeModal = $('#closeModal');

    const cartFab = $('#cartFab');
    const drawer = $('#drawer');
    const drawerClose = $('#drawerClose');
    const cartList = $('#cartList');
    const subEl = $('#sub');
    const taxEl = $('#tax');
    const totalEl = $('#total');
    const clearBtn = $('#clear');
    const checkoutBtn = $('#checkout');
    const toast = $('#toast');

    // === Tamaños ===
    const SIZES = {
      normal: { label: 'Normal' },
      especial: { label: 'Especial' }
    };

    // === Variantes (estilos de relleno) ===
    const VARIANTES = {
      lechon: { label: 'Lechón' },
      rellenoNegro: { label: 'Relleno Negro' },
      pavoAsado: { label: 'Pavo Asado' },
      pocChuc: { label: 'Poc Chuc' }
    };

    // === PRECIOS reales por categoría, tamaño y variante ===
    // ⚠️ Valores provisionales tomados de tu referencia. Dime si hay que ajustarlos y los cambio al instante.
    const PRECIOS = {
      trancas: {
        normal:   { lechon: 85,  rellenoNegro: 90,  pavoAsado: 60,  pocChuc: 65 },
        especial: { lechon: 95,  rellenoNegro: 100, pavoAsado: 70,  pocChuc: 75 }
      },
      tortas: {
        normal:   { lechon: 35,  rellenoNegro: 35,  pavoAsado: 35,  pocChuc: 35 },
        especial: { lechon: 45,  rellenoNegro: 45,  pavoAsado: 45,  pocChuc: 45 }
      },
      panuchos: {
        normal:   { lechon: 25,  rellenoNegro: 25,  pavoAsado: 25,  pocChuc: 25 },
        especial: { lechon: 30,  rellenoNegro: 30,  pavoAsado: 30,  pocChuc: 30 }
      },
      tacos: {
        normal:   { lechon: 25,  rellenoNegro: 25,  pavoAsado: 25,  pocChuc: 25 },
        especial: { lechon: 30,  rellenoNegro: 30,  pavoAsado: 30,  pocChuc: 30 }
      },
      tostadas: {
        normal:   { lechon: 25,  rellenoNegro: 25,  pavoAsado: 25,  pocChuc: 25 },
        especial: { lechon: 30,  rellenoNegro: 30,  pavoAsado: 30,  pocChuc: 30 }
      }
    };

    // === Catálogo base ===
    const CATALOGO = [
      { id: 101, name: 'Tranca',   cat: 'trancas',   img: 'https://images.unsplash.com/photo-1604908811848-025f3b2a8371', desc: 'Pan grande con relleno a elegir', available: true },
      { id: 201, name: 'Torta',    cat: 'tortas',    img: 'https://images.unsplash.com/photo-1619740462125-0b8a3d9e8643', desc: 'Bolillo con relleno a elegir', available: true },
      { id: 301, name: 'Panuchos', cat: 'panuchos',  img: 'https://images.unsplash.com/photo-1632516643720-3b3ad72037df', desc: 'Tortilla con frijol y relleno', available: true },
      { id: 401, name: 'Tacos',    cat: 'tacos',     img: 'https://images.unsplash.com/photo-1552332386-f8dd00dc2f85', desc: 'Orden con salsas al gusto', available: true },
      { id: 501, name: 'Tostadas', cat: 'tostadas',  img: 'https://images.unsplash.com/photo-1546549039-49ec6f3b2c4b', desc: 'Crujientes con frijol y relleno', available: true },
    ];

    function getPrice(cat, size, variant){
      const catTable = PRECIOS[cat] || {};
      const sizeTable = catTable[size] || {};
      const val = sizeTable[variant];
      return Number(val ?? 0);
    }

    // Helpers para chips de selección
    function buildSegmented(container, optionsMap, defaultKey, onChange){
      container.classList.add('segmented');
      Object.entries(optionsMap).forEach(([key, obj])=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'seg-btn';
        btn.dataset.value = key;
        btn.setAttribute('role','tab');
        btn.setAttribute('aria-selected', key===defaultKey ? 'true' : 'false');
        btn.textContent = obj.label || key;
        if(key===defaultKey) btn.classList.add('active');
        btn.addEventListener('click',()=>{
          container.querySelectorAll('.seg-btn').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
          btn.classList.add('active');
          btn.setAttribute('aria-selected','true');
          onChange?.(key, obj);
        });
        // teclado: flechas izquierda/derecha para moverse
        btn.addEventListener('keydown',(e)=>{
          if(e.key!=='ArrowRight' && e.key!=='ArrowLeft') return;
          e.preventDefault();
          const buttons = Array.from(container.querySelectorAll('.seg-btn'));
          const i = buttons.indexOf(btn);
          const next = e.key==='ArrowRight' ? (i+1)%buttons.length : (i-1+buttons.length)%buttons.length;
          buttons[next].focus();
        });
        container.appendChild(btn);
      });
    }
    function getActiveValue(container){
      return container.querySelector('.seg-btn.active')?.dataset.value;
    }
    function getSelText(card, cls){
      const el = card.querySelector('.'+cls);
      if(el && el.tagName==='SELECT'){ return el.selectedOptions[0]?.text || ''; }
      const seg = card.querySelector('.'+cls+'-seg .seg-btn.active');
      return seg?.textContent || '';
    }

    function renderMenu(){
      menuGrid.innerHTML = '';
      CATALOGO.forEach(({id,name,cat,img,desc,available})=>{
        const defSize = Object.keys(SIZES)[0];
        const defVar  = Object.keys(VARIANTES)[0];
        const price = getPrice(cat, defSize, defVar);
        const card = document.createElement('article');
        card.className = 'card';
        card.dataset.id = String(id);
        card.dataset.name = name;
        card.dataset.price = String(price);
        card.dataset.cat = cat;
        card.dataset.size = defSize;
        card.dataset.variant = defVar;
        card.dataset.available = String(available);
        card.innerHTML = `
          <div class="img-wrap">
            <img src="${img}" alt="${name}" />
          </div>
          <div class="card-body">
            <div class="title-row"><span class="name">${name}</span><span class="price">$${price.toFixed(2)}</span></div>
            <p class="desc">${desc}</p>
            <div class="size-seg" aria-label="Selecciona tamaño"></div>
            <div class="select-wrap">
              <select class="variant" aria-label="Selecciona estilo">
                ${Object.entries(VARIANTES).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}
              </select>
            </div>
            <div class="meta"><span class="badge">Elige tamaño y estilo</span></div>
            <div class="actions-row">
              <button class="btn view-btn">Ver</button>
              <button class="btn primary add-btn">Añadir</button>
            </div>
          </div>`;
        const priceEl = card.querySelector('.price');
        const sizeSeg = card.querySelector('.size-seg');
        const varSel  = card.querySelector('.variant');
        const varWrap = varSel.closest('.select-wrap');
        const recalc = ()=>{
          const sz = getActiveValue(sizeSeg) || defSize;
          const vr = varSel.value || defVar;
          const newPrice = getPrice(cat, sz, vr);
          card.dataset.price = String(newPrice);
          card.dataset.size = sz;
          card.dataset.variant = vr;
          priceEl.textContent = `$${newPrice.toFixed(2)}`;
        };
        buildSegmented(sizeSeg, SIZES, defSize, ()=>recalc());
        varSel.addEventListener('change', recalc);
        ;['focus','blur','click'].forEach(evt=>{ varSel.addEventListener(evt, ()=> varWrap.classList.toggle('open', document.activeElement===varSel)); });
        menuGrid.appendChild(card);
      });
    }

    yearSpan.textContent = new Date().getFullYear();

    // Estado
    let cart = [];
    const TAX = 0; // ajusta si lo necesitas

    // Persistencia
    const loadCart = ()=>{ try{ cart = JSON.parse(localStorage.getItem('cart')||'[]'); }catch{ cart=[] } };
    const saveCart = ()=> localStorage.setItem('cart', JSON.stringify(cart));

    // Carrito helpers
    const cartCount = ()=> cart.reduce((a,i)=>a+i.qty,0);
    const cartSubtotal = ()=> cart.reduce((a,i)=>a+i.price*i.qty,0);

    function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); }

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }

    function addToCart({id,name,price,img}){
      const found = cart.find(i=>i.id===id);
      if(found){ found.qty += 1; }
      else { cart.push({id,name,price,qty:1,img}); }
      updateCartUI();
      saveCart();
      showToast('Añadido al carrito');
      // sonido al agregar
      try{ const s = document.getElementById('sonido-agregar'); s.currentTime = 0; s.play(); }catch(err){}
    }

    function removeFromCart(id){ cart = cart.filter(i=>i.id!==id); updateCartUI(); saveCart(); }
    function changeQty(id, delta){
      const it = cart.find(i=>i.id===id);
      if(!it) return;
      const next = (it.qty || 0) + delta;
      if(next <= 0){
        // Si la cantidad llega a 0 o menos, elimina el ítem del carrito
        cart = cart.filter(i=>i.id !== id);
      }else{
        it.qty = next;
      }
      updateCartUI();
      saveCart();
    }
    function clearCart(){ cart = []; updateCartUI(); saveCart(); }

    function updateCartUI(){
      cartList.innerHTML = '';
      if(cart.length===0){ cartList.innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px">Tu carrito está vacío</div>'; }
      cart.forEach(i=>{
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <img class="thumb" src="${i.img}" alt="${i.name}">
          <div>
            <div class="i-name">${i.name}</div>
            <div class="i-price">${fmt(i.price)}</div>
            <div class="qty" aria-label="Cantidad">
              <button class="step" data-step="-1" aria-label="Disminuir">−</button>
              <span>${i.qty}</span>
              <button class="step" data-step="1" aria-label="Aumentar">+</button>
              <button class="remove" aria-label="Eliminar">Eliminar</button>
            </div>
          </div>
          <div>${fmt(i.price*i.qty)}</div>
        `;
        row.querySelector('[data-step="-1"]').onclick = ()=>changeQty(i.id,-1);
        row.querySelector('[data-step="1"]').onclick = ()=>changeQty(i.id,1);
        row.querySelector('.remove').onclick = ()=>removeFromCart(i.id);
        cartList.appendChild(row);
      });
      const sub = cartSubtotal();
      const tax = sub*TAX;
      const tot = sub+tax;
      subEl.textContent = fmt(sub); taxEl.textContent = fmt(tax); totalEl.textContent = fmt(tot);
      cartFab.textContent = `Carrito (${cartCount()})`;
    }

    // Filtros
    function applyFilters(){
      const q = searchInput.value.trim().toLowerCase();
      const active = $('.tab.active')?.dataset.cat || 'all';
      $$('.card', menuGrid).forEach(card=>{
        const matchText = card.dataset.name.toLowerCase().includes(q);
        const matchCat = active==='all' || card.dataset.cat===active;
        card.style.display = (matchText && matchCat) ? '' : 'none';
      });
    }

    // Listeners UI
    searchInput.addEventListener('input', applyFilters);
    resetBtn.addEventListener('click', ()=>{ searchInput.value=''; $$('.tab').forEach(t=>t.classList.remove('active')); $$('.tab')[0].classList.add('active'); applyFilters();
    updateAvailabilityUI(); });
    tabs.addEventListener('click', (e)=>{ const t=e.target.closest('.tab'); if(!t) return; $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); applyFilters(); });

    // Refresca badges/estado según disponibilidad del dataset
    function updateAvailabilityUI(){
      $$('.card', menuGrid).forEach(card=>{
        const available = String(card.dataset.available).toLowerCase() !== 'false';
        const addBtn = card.querySelector('.add-btn');
        const meta = card.querySelector('.meta');
        let agot = meta?.querySelector('.badge.agotado[data-gen="1"]');
        if(!available){
          addBtn?.setAttribute('disabled','');
          if(!agot && meta){
            agot = document.createElement('span');
            agot.className = 'badge agotado';
            agot.setAttribute('data-gen','1');
            agot.textContent = 'Agotado';
            meta.appendChild(agot);
          }
        }else{
          addBtn?.removeAttribute('disabled');
          agot?.remove();
        }
      });
    }

    // Grid: ver y añadir (con disponibilidad y notificación de agotado)
    menuGrid.addEventListener('click', (e)=>{
      const card = e.target.closest('.card');
      if(!card) return;
      if(e.target.classList.contains('view-btn') || e.target.tagName==='IMG'){
        modalImg.src = card.querySelector('img').src;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
      if(e.target.classList.contains('add-btn')){
        const available = String(card.dataset.available).toLowerCase() !== 'false';
        if(!available){
          const note = document.getElementById('notificacion-agotado');
          note.classList.remove('oculto');
          note.classList.add('mostrar');
          setTimeout(()=>{ note.classList.remove('mostrar'); setTimeout(()=>note.classList.add('oculto'),350); },1800);
          return;
        }
        addToCart({
          id: Number(card.dataset.id),
          name: `${card.dataset.name} — ${getSelText(card,'variant')} — ${getSelText(card,'size')}`.trim(),
          price: Number(card.dataset.price),
          img: card.querySelector('img').src
        });
      }
    });

    // Modal: cerrar por botón, clic fuera y tecla ESC + restaurar scroll
    $('#closeModal').addEventListener('click', ()=>{ modal.classList.remove('show'); document.body.style.overflow=''; });
    modal.addEventListener('click',(e)=>{ if(e.target===modal){ modal.classList.remove('show'); document.body.style.overflow=''; } });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.classList.contains('show')){ modal.classList.remove('show'); document.body.style.overflow=''; } });

    // Drawer
    cartFab.addEventListener('click', openDrawer);
    drawerClose.addEventListener('click', closeDrawer);
    drawer.addEventListener('click', (e)=>{ if(e.target===drawer) closeDrawer(); });

    clearBtn.addEventListener('click', clearCart);

    // Confirmar pedido por WhatsApp
    checkoutBtn.addEventListener('click', () => {
      if (!cart.length) return showToast('Tu carrito está vacío');
      const telefonoRestaurante = '521234567890'; // Cambia por tu número con prefijo país
      let mensaje = '📋 *Nuevo pedido*\n\n';
      cart.forEach(item => { mensaje += `🍽️ ${item.name} x${item.qty} — ${fmt(item.price * item.qty)}\n`; });
      mensaje += `\n💵 *Total:* ${fmt(cartSubtotal())}\n`;
      mensaje += `\n📍 Por favor, confirme su dirección de entrega.`;
      const url = `https://wa.me/${telefonoRestaurante}?text=${encodeURIComponent(mensaje)}`;
      window.open(url, '_blank');
      closeDrawer();
    });

    // Init
    renderMenu();
    loadCart();
    updateCartUI();
    applyFilters();
    updateAvailabilityUI();

    // Sincroniza con cambios externos en localStorage (cada 3s)
    let lastCartSnapshot = localStorage.getItem('cart');
    setInterval(()=>{
      const snap = localStorage.getItem('cart');
      if(snap !== lastCartSnapshot){
        lastCartSnapshot = snap;
        try{ cart = JSON.parse(snap||'[]'); }catch{ cart=[] }
        updateCartUI();
      }
      // si cambias data-available dinámicamente, reevalúa badges/estado
      updateAvailabilityUI();
    },3000);

    // Self-tests (no afectan al UI)
    (function testGetPrice(){
      console.group('Self-tests');
      // Tests originales
      console.assert(getPrice('trancas','normal','lechon') === 85, 'Trancas normal Lechón debe ser 85');
      console.assert(getPrice('trancas','especial','pavoAsado') === 70, 'Trancas especial Pavo Asado debe ser 70');
      console.assert(getPrice('tortas','especial','pocChuc') === 45, 'Tortas especial Poc Chuc debe ser 45');
      // Tests adicionales
      console.assert(getPrice('panuchos','normal','lechon') === 25, 'Panuchos normal Lechón debe ser 25');
      console.assert(getPrice('tacos','especial','pocChuc') === 30, 'Tacos especial Poc Chuc debe ser 30');
      console.assert(getPrice('tostadas','normal','rellenoNegro') === 25, 'Tostadas normal Relleno Negro debe ser 25');
      console.groupEnd();
    })();

    // Año en footer
    yearSpan.textContent = new Date().getFullYear();

    // Giro del logo al clic
    const brandLogo = document.getElementById('brandLogo');
    brandLogo?.addEventListener('click',()=>{ brandLogo.classList.add('spin'); setTimeout(()=>brandLogo.classList.remove('spin'),600); });
  </script>
</body>
</html>
